<!DOCTYPE html>
<html>
    <head>
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width, minimum-scale=1, initial-scale=1, user-scalable=yes">

      <title>Elm Firebase interaciton</title>
      <meta name="description" content="elm firebase">


      <!-- MDL -->
      <link href='https://fonts.googleapis.com/css?family=Roboto:400,300,500|Roboto+Mono|Roboto+Condensed:400,700&subset=latin,latin-ext' rel='stylesheet' type='text/css'>
      <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">

      <link rel="stylesheet" href="https://code.getmdl.io/1.3.0/material.green-orange.min.css" />



      <script src="https://cdn.polyfill.io/v2/polyfill.js?features=Event.focusin"></script>


      <!-- FIREBASE -->
      <script src="https://www.gstatic.com/firebasejs/3.9.0/firebase.js"></script>
      <script src="https://www.gstatic.com/firebasejs/3.9.0/firebase-app.js"></script>
      <script src="https://www.gstatic.com/firebasejs/3.9.0/firebase-auth.js"></script>
      <script src="https://www.gstatic.com/firebasejs/3.9.0/firebase-database.js"></script>
      <script src="https://www.gstatic.com/firebasejs/3.9.0/firebase-messaging.js"></script>



      <script src="https://www.gstatic.com/firebasejs/3.9.0/firebase.js"></script>
      <script>
        // Initialize Firebase
        var config = {
          apiKey: "AIzaSyDG-7OphM36BpQkMuNvVbsOxdGx0kgADvY",
          authDomain: "prova-ede5b.firebaseapp.com",
          databaseURL: "https://prova-ede5b.firebaseio.com",
          projectId: "prova-ede5b",
          storageBucket: "prova-ede5b.appspot.com",
          messagingSenderId: "475414347726"
        };
        firebase.initializeApp(config);

        var provider = new firebase.auth.GoogleAuthProvider();
        provider.setCustomParameters({prompt:"select_account"});
        defaultStorage = firebase.storage();
        defaultDatabase = firebase.database();

      </script>


    </head>

    <body>


      <div id="main"> </div>

      <script src="Main.js"></script>
      <script>

          var node = document.getElementById('main');
          var app = Elm.Main.embed(node);

          app.ports.toFirebase.subscribe(function(obj) {
            console.log(obj);
              if (obj.action == "push"){
                var ref = defaultDatabase.ref(obj.path);
                var newKey = ref.push().key;
                var updates = {};
                updates[ newKey] = {question:"question ..." , answers : {}};
                ref.update(updates);
                console.log(newKey);
              }else if (obj.action == "IN"){
                signin();
              } else   if (obj.action == "OUT"){
                signout();
              } else   if (obj.action == "QUERY"){
                query();
              }else{
                console.log("command error: " + str );
              }

          });

          var signin = function() {
            firebase.auth().signInWithPopup(provider).then(function(result) {
              // This gives you a Google Access Token. You can use it to access the Google API.
              var token = result.credential.accessToken;
              // The signed-in user info.
              var user = result.user;
              // ...
              console.log(user.displayName);
              app.ports.fromFirebase.send(user.displayName);

            }).catch(function(error) {
              // Handle Errors here.
              var errorCode = error.code;
              var errorMessage = error.message;
              // The email of the user's account used.
              var email = error.email;
              // The firebase.auth.AuthCredential type that was used.
              var credential = error.credential;
              // ...
              console.log(errorMessage);
              ret =  errorMessage;
              app.ports.fromFirebase.send(error.message);
            });
          };

          var signout = function (){
            firebase.auth().signOut().then(function() {
              app.ports.fromFirebase.send("SignOut");
            }).catch(function(error) {
              app.ports.fromFirebase.send("SignOut Error");
            });

          };

          var query = function (){
            var ref = firebase.database().ref("posts/-KiqqpoBI7J9mAvNVfem/");

            ref.on("value", function(snapshot) {
               console.log(snapshot.val());
               app.ports.fromFirebase.send(snapshot.val().body);
            }, function (error) {
               console.log("Error: " + error.code);
            });

          };


      </script>

  </body>

</html>
